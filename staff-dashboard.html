<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - Usanii Mashariki Gallery</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style>
        /* General Styles - Inherited or customized from main styles */
        :root {
            --primary-color: #0056b3; /* Darker blue for staff theme */
            --secondary-color: #007bff; /* Lighter blue */
            --accent-color: #28a745; /* Green for success/highlight */
            --text-dark: #343a40;
            --text-light: #6c757d;
            --bg-light: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--bg-light);
            display: flex;
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        a {
            text-decoration: none;
            color: var(--primary-color);
            transition: var(--transition);
        }

        a:hover {
            color: var(--secondary-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-success {
            background-color: var(--accent-color);
            color: var(--white);
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-info {
            background-color: var(--info-color);
            color: var(--white);
        }

        .btn-info:hover {
            opacity: 0.9;
        }

        .text-center {
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--primary-color), #003366);
            color: var(--white);
            padding: 2rem 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar .logo {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 2rem;
            color: var(--white);
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .sidebar nav li {
            width: 100%;
            margin-bottom: 1rem;
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--white);
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 1.1rem;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--accent-color);
        }

        .sidebar .user-info {
            margin-top: auto; /* Pushes user info to the bottom */
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
        }

        .sidebar .user-info p {
            margin: 0.5rem 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar .user-info .btn-outline {
            color: var(--white);
            border-color: var(--white);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .sidebar .user-info .btn-outline:hover {
            background: var(--white);
            color: var(--primary-color);
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            color: var(--text-dark);
        }

        .section-panel {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .section-panel h2 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--bg-light);
            padding-bottom: 1rem;
        }

        /* Overview Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        .stat-card .icon {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-dark);
        }

        .stat-card .label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: var(--white);
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .data-table tr:nth-child(even) {
            background-color: var(--bg-light);
        }

        .data-table tr:hover {
            background-color: #f1f1f1;
        }

        /* Reports Section */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .report-card {
            background: var(--white);
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .report-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .report-card h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .report-card p {
            color: var(--text-light);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .report-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .report-actions .btn {
            flex: 1;
            min-width: 120px;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        

        /* Status Badges */
        .status-badge {
            padding: 0.3em 0.6em;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }
        .status-approved { background-color: var(--success-color); color: #000; }
        .status-pending, .status-under_review { background-color: var(--warning-color); color: var(--text-dark);}
        .status-rejected { background-color: var(--danger-color); }
        .status-draft { background-color: var(--text-light); }
        /* Exhibitions */
        .status-upcoming { background-color: var(--warning-color); color: #000; }
        .status-active { background-color: #d1e7dd; color: #000; }
        .status-completed { background-color: #e2e3e5; color: #000; }
        /* Users (roles and status) - improve contrast */
        .status-visitor { background-color: #e2e3e5; color: #000; }
        .status-artist { background-color: #cfe2ff; color: #000; }
        .status-staff { background-color: #e7f1ff; color: #000; }
        .status-active { background-color: #d1e7dd; color: #000; }
        .status-inactive, .status-suspended { background-color: #fff3cd; color: #000; }
        .status-banned { background-color: #f8d7da; color: #000; }

        /* Category text color only */
        .category-text { color: #004085; font-weight: 600; }

        /* Exhibition Artworks */
        .artwork-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            background: white;
        }

        .artwork-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .artwork-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .artwork-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-dark);
        }

        .artwork-info p {
            margin: 0.25rem 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-dark);
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group input[type="file"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input[type="file"] {
            padding: 0.5rem;
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            width: 90%;
            max-width: 700px;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-button {
            color: var(--text-light);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--danger-color);
        }

        /* Alerts/Messages */
        .message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            font-weight: bold;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .artwork-thumbnail {
            max-width: 80px;
            max-height: 80px;
            border-radius: var(--border-radius);
            object-fit: cover;
            vertical-align: middle;
            margin-right: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 999;
            }

            .sidebar .logo {
                margin-bottom: 0;
            }

            .sidebar nav {
                display: none; /* Hide nav by default on small screens */
            }
            
            .sidebar .user-info {
                margin-top: 0;
                padding-top: 0;
                border-top: none;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            ⚙️ Staff Dashboard
        </div>
        <nav>
            <ul>
                <li><a href="#overview" class="active" data-section="overview">📊 Overview</a></li>
                <li><a href="#submissions" data-section="submissions">📮 Submissions</a></li>
                <li><a href="#artworks" data-section="artworks">🖼️ Artworks</a></li>
                <li><a href="#exhibitions" data-section="exhibitions">🏛️ Exhibitions</a></li>
                <li><a href="#categories" data-section="categories">🗂️ Categories</a></li>
                <li><a href="#users" data-section="users">👥 Users</a></li>
                <li><a href="#reports" data-section="reports">📋 Reports</a></li>
            </ul>
        </nav>
        <div class="user-info">
            <p>Logged in as: <span id="userName"></span></p>
            <p>Role: <span id="userRole"></span></p>
            <button class="btn btn-outline" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-header">
            <h1 id="dashboardTitle">Dashboard Overview</h1>
            <div>
                <button class="btn btn-primary" id="addNewBtn" style="display: none;">➕ Add New</button>
            </div>
        </div>

        <section id="overview" class="section-panel">
            <h2>Gallery Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">🖼️</div>
                    <div class="number" id="totalArtworks">0</div>
                    <div class="label">Total Artworks</div>
                </div>
                <div class="stat-card">
                    <div class="icon">🧑‍🎨</div>
                    <div class="number" id="totalArtists">0</div>
                    <div class="label">Active Artists</div>
                </div>
                <div class="stat-card">
                    <div class="icon">📮</div>
                    <div class="number" id="pendingSubmissions">0</div>
                    <div class="label">Pending Submissions</div>
                </div>
                <div class="stat-card">
                    <div class="icon">🏛️</div>
                    <div class="number" id="activeExhibitions">0</div>
                    <div class="label">Active Exhibitions</div>
                </div>
            </div>
        </section>

        <section id="submissions" class="section-panel" style="display: none;">
            <h2>Artwork Submissions</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Artwork</th>
                            <th>Artist</th>
                            <th>Submitted At</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody">
                        <tr><td colspan="5" class="text-center">Loading submissions...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="artworks" class="section-panel" style="display: none;">
            <h2>All Artworks</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Artist</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Featured</th>
                            <th>Views</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="artworksTableBody">
                        <tr><td colspan="8" class="text-center">Loading artworks...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="exhibitions" class="section-panel" style="display: none;">
            <h2>Exhibitions</h2>
            <!-- Removed duplicate Add New Exhibition button -->
            <div class="table-responsive" style="margin-top: 1rem;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Dates</th>
                            <th>Artworks</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="exhibitionsTableBody">
                        <tr><td colspan="5" class="text-center">Loading exhibitions...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="categories" class="section-panel" style="display: none;">
            <h2>Categories</h2>
            <!-- Removed duplicate Add New Category button -->
            <div class="table-responsive" style="margin-top: 1rem;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Artworks Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <tr><td colspan="4" class="text-center">Loading categories...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="users" class="section-panel" style="display: none;">
            <h2>User Management</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="5" class="text-center">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="reports" class="section-panel" style="display: none;">
            <h2>📋 Download Reports</h2>
            <p>Generate and download various reports in CSV or PDF format.</p>
            
            <div class="reports-grid">
                <div class="report-card">
                    <h3>🖼️ Artworks Report</h3>
                    <p>Complete list of all artworks with details including artist information, categories, and status.</p>
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="downloadReport('artworks', 'csv')">📄 Download CSV</button>
                        <button class="btn btn-outline" onclick="downloadReport('artworks', 'pdf')">📄 Download PDF</button>
                    </div>
                </div>

                <div class="report-card">
                    <h3>🧑‍🎨 Artists Report</h3>
                    <p>Artist information including artwork counts, approved works, and sales statistics.</p>
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="downloadReport('artists', 'csv')">📄 Download CSV</button>
                        <button class="btn btn-outline" onclick="downloadReport('artists', 'pdf')">📄 Download PDF</button>
                    </div>
                </div>

                <div class="report-card">
                    <h3>💰 Sales Report</h3>
                    <p>Payment and sales data including transaction details, buyer/seller information, and receipts.</p>
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="downloadReport('sales', 'csv')">📄 Download CSV</button>
                        <button class="btn btn-outline" onclick="downloadReport('sales', 'pdf')">📄 Download PDF</button>
                    </div>
                </div>

                <div class="report-card">
                    <h3>👥 Users Report</h3>
                    <p>User account information including roles, status, and registration dates.</p>
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="downloadReport('users', 'csv')">📄 Download CSV</button>
                        <button class="btn btn-outline" onclick="downloadReport('users', 'pdf')">📄 Download PDF</button>
                    </div>
                </div>

                <div class="report-card">
                    <h3>🏛️ Exhibitions Report</h3>
                    <p>Exhibition details including dates, status, and artwork counts.</p>
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="downloadReport('exhibitions', 'csv')">📄 Download CSV</button>
                        <button class="btn btn-outline" onclick="downloadReport('exhibitions', 'pdf')">📄 Download PDF</button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- Review Submission Modal -->
    <div id="reviewSubmissionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="reviewSubmissionModal">&times;</span>
            <h2>Review Artwork Submission</h2>
            <form id="reviewSubmissionForm">
                <input type="hidden" id="reviewSubmissionId">
                <input type="hidden" id="csrf_token_review_submission" value="">
                <div class="form-group">
                    <label>Artwork Title:</label>
                    <p id="reviewArtworkTitle"></p>
                </div>
                <div class="form-group">
                    <label>Artist Name:</label>
                    <p id="reviewArtistName"></p>
                </div>
                <div class="form-group">
                    <label>Submission Notes:</label>
                    <p id="submissionReviewNotes"></p>
                </div>
                <div class="form-group">
                    <label for="reviewAction">Action:</label>
                    <select id="reviewAction" required>
                        <option value="">Select Action</option>
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reviewerNotes">Reviewer Notes (Optional):</label>
                    <textarea id="reviewerNotes" rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit Review</button>
                <div id="reviewSubmissionMessage" class="message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Edit Artwork Modal (from Artist Dashboard, potentially reused/modified) -->
    <div id="editArtworkModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="editArtworkModal">&times;</span>
            <h2>Edit Artwork</h2>
            <form id="editArtworkForm">
                <input type="hidden" id="editArtworkId">
                <input type="hidden" id="csrf_token_edit_artwork" value="">
                <div class="form-group">
                    <label for="editArtworkTitle">Title</label>
                    <input type="text" id="editArtworkTitle" required>
                </div>
                <div class="form-group">
                    <label for="editArtworkDescription">Description</label>
                    <textarea id="editArtworkDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editArtworkCategory">Category</label>
                    <select id="editArtworkCategory" required>
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editArtworkMedium">Medium</label>
                    <input type="text" id="editArtworkMedium">
                </div>
                <div class="form-group">
                    <label for="editArtworkDimensions">Dimensions</label>
                    <input type="text" id="editArtworkDimensions">
                </div>
                <div class="form-group">
                    <label for="editArtworkYear">Year Created</label>
                    <input type="number" id="editArtworkYear" min="1000" max="2100">
                </div>
                <div class="form-group">
                    <label for="editArtworkPrice">Price ($)</label>
                    <input type="number" id="editArtworkPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="editArtworkStatus">Status</label>
                    <select id="editArtworkStatus">
                        <option value="draft">Draft</option>
                        <option value="submitted">Submitted</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editArtworkFeatured">Featured</label>
                    <input type="checkbox" id="editArtworkFeatured">
                </div>
                <div class="form-group">
                    <label>Current Image</label>
                    <img id="currentArtworkImage" class="artwork-thumbnail" src="#" alt="Current Artwork Image">
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-danger" onclick="deleteArtwork()">Delete Artwork</button>
                <div id="editArtworkMessage" class="message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Add Exhibition Modal -->
    <div id="addExhibitionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="addExhibitionModal">&times;</span>
            <h2>Add New Exhibition</h2>
            <form id="addExhibitionForm">
                <input type="hidden" id="csrf_token_add_exhibition" value="">
                <div class="form-group">
                    <label for="exhibitionName">Name</label>
                    <input type="text" id="exhibitionName" required>
                </div>
                <div class="form-group">
                    <label for="exhibitionDescription">Description</label>
                    <textarea id="exhibitionDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="exhibitionStartDate">Start Date</label>
                    <input type="date" id="exhibitionStartDate" required>
                </div>
                <div class="form-group">
                    <label for="exhibitionEndDate">End Date</label>
                    <input type="date" id="exhibitionEndDate" required>
                </div>
                <div class="form-group">
                    <label for="exhibitionMaxArtworks">Max Artworks</label>
                    <input type="number" id="exhibitionMaxArtworks" value="50" min="1">
                </div>
                <button type="submit" class="btn btn-primary">Create Exhibition</button>
                <div id="addExhibitionMessage" class="message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="addCategoryModal">&times;</span>
            <h2>Add New Category</h2>
            <form id="addCategoryForm">
                <input type="hidden" id="csrf_token_add_category" value="">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Description (Optional)</label>
                    <textarea id="categoryDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Category</button>
                <div id="addCategoryMessage" class="message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Change User Role Modal -->
    <div id="changeRoleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="changeRoleModal">&times;</span>
            <h2>Change User Role</h2>
            <form id="changeRoleForm">
                <input type="hidden" id="changeRoleUserId">
                <input type="hidden" id="csrf_token_change_role" value="">
                <p>Changing role for: <strong id="changeRoleUserName"></strong></p>
                <div class="form-group">
                    <label for="newUserRole">New Role:</label>
                    <select id="newUserRole" required>
                        <option value="">Select Role</option>
                        <option value="visitor">Visitor</option>
                        <option value="artist">Artist</option>
                        <option value="staff">Staff</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Update Role</button>
                <div id="changeRoleMessage" class="message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Exhibition Artworks Management Modal -->
    <div id="exhibitionArtworksModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <span class="close-button" data-modal="exhibitionArtworksModal">&times;</span>
            <h2>Manage Exhibition Artworks</h2>
            <input type="hidden" id="csrf_token_exhibition_artworks" value="">
            
            <div style="margin-bottom: 2rem;">
                <h3>Add Artwork to Exhibition</h3>
                <div style="display: flex; gap: 1rem; align-items: end;">
                    <div style="flex: 1;">
                        <label for="availableArtworksSelect">Select Artwork:</label>
                        <select id="availableArtworksSelect" style="width: 100%; padding: 0.5rem;">
                            <option value="">Loading available artworks...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addArtworkToExhibition()">Add Artwork</button>
                </div>
            </div>
            
            <div>
                <h3>Current Exhibition Artworks</h3>
                <div id="exhibitionArtworksContainer">
                    <p>Loading artworks...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/usanii_mashariki';
        let currentUser = null;
        let categories = []; // Store fetched categories globally

        const sections = {
            'overview': document.getElementById('overview'),
            'submissions': document.getElementById('submissions'),
            'artworks': document.getElementById('artworks'),
            'exhibitions': document.getElementById('exhibitions'),
            'categories': document.getElementById('categories'),
            'users': document.getElementById('users'),
            'reports': document.getElementById('reports'),
        };

        const dashboardTitle = document.getElementById('dashboardTitle');
        const userNameSpan = document.getElementById('userName');
        const userRoleSpan = document.getElementById('userRole');
        const addNewBtn = document.getElementById('addNewBtn');

        // Modals
        const reviewSubmissionModal = document.getElementById('reviewSubmissionModal');
        const reviewSubmissionForm = document.getElementById('reviewSubmissionForm');
        const reviewSubmissionMessage = document.getElementById('reviewSubmissionMessage');
        const csrfTokenReviewSubmissionInput = document.getElementById('csrf_token_review_submission');

        const editArtworkModal = document.getElementById('editArtworkModal');
        const editArtworkForm = document.getElementById('editArtworkForm');
        const editArtworkMessage = document.getElementById('editArtworkMessage');
        const editArtworkCategorySelect = document.getElementById('editArtworkCategory');
        const currentArtworkImage = document.getElementById('currentArtworkImage');
        const csrfTokenEditArtworkInput = document.getElementById('csrf_token_edit_artwork');
        let currentEditArtworkId = null;

        const addExhibitionModal = document.getElementById('addExhibitionModal');
        const addExhibitionForm = document.getElementById('addExhibitionForm');
        const addExhibitionMessage = document.getElementById('addExhibitionMessage');
        const csrfTokenAddExhibitionInput = document.getElementById('csrf_token_add_exhibition');

        const addCategoryModal = document.getElementById('addCategoryModal');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const addCategoryMessage = document.getElementById('addCategoryMessage');
        const csrfTokenAddCategoryInput = document.getElementById('csrf_token_add_category');

        const changeRoleModal = document.getElementById('changeRoleModal');
        const changeRoleForm = document.getElementById('changeRoleForm');
        const changeRoleMessage = document.getElementById('changeRoleMessage');
        const changeRoleUserIdInput = document.getElementById('changeRoleUserId');
        const csrfTokenChangeRoleInput = document.getElementById('csrf_token_change_role');

        const exhibitionArtworksModal = document.getElementById('exhibitionArtworksModal');
        const csrfTokenExhibitionArtworksInput = document.getElementById('csrf_token_exhibition_artworks');


        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthAndRedirect();
            await fetchCsrfToken();
            await loadCategories(); // Load categories for forms

            if (currentUser) {
                // Prevent undefined flicker on overview stats
                document.getElementById('totalArtworks').textContent = '0';
                document.getElementById('totalArtists').textContent = '0';
                document.getElementById('pendingSubmissions').textContent = '0';
                document.getElementById('activeExhibitions').textContent = '0';

                loadGalleryOverviewStats();
                loadSubmissions();
                loadAllArtworks();
                loadExhibitions();
                loadCategoriesTable();
                loadUsers();
            }
        });

        // CSRF Token Fetching
        async function fetchCsrfToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/csrf-token`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    csrfTokenReviewSubmissionInput.value = data.csrf_token;
                    csrfTokenEditArtworkInput.value = data.csrf_token;
                    csrfTokenAddExhibitionInput.value = data.csrf_token;
                    csrfTokenAddCategoryInput.value = data.csrf_token;
                    csrfTokenChangeRoleInput.value = data.csrf_token;
                    csrfTokenExhibitionArtworksInput.value = data.csrf_token;
                } else {
                    console.error('Failed to fetch CSRF token:', data.message);
                }
            } catch (error) {
                console.error('Error fetching CSRF token:', error);
            }
        }

        async function checkAuthAndRedirect() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/status`, { credentials: 'include' });
                const data = await response.json();

                if (!data.success || !data.user || data.user.role !== 'staff') {
                    window.location.href = 'login.html'; // Redirect to login if not authenticated as staff
                } else {
                    currentUser = data.user;
                    userNameSpan.textContent = currentUser.name;
                    userRoleSpan.textContent = currentUser.role;
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = 'login.html'; // Redirect on network error or server issue
            }
        }

        async function logout() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    window.location.href = 'index.html'; // Redirect to homepage after logout
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Error during logout:', error);
                alert('Logout failed due to a network error.');
            }
        }

        // Sidebar Navigation
        document.querySelectorAll('.sidebar nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.dataset.section;
                showSection(sectionId);

                // Update active class
                document.querySelectorAll('.sidebar nav a').forEach(navLink => navLink.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function showSection(sectionId) {
            for (const key in sections) {
                sections[key].style.display = 'none';
            }
            sections[sectionId].style.display = 'block';
            const sectionTitles = {
                overview: 'Dashboard Overview',
                submissions: 'Submissions',
                artworks: 'Artworks',
                exhibitions: 'Exhibitions',
                categories: 'Categories',
                users: 'Users',
                reports: 'Reports'
            };
            dashboardTitle.textContent = sectionTitles[sectionId] || 'Overview';

            // Adjust Add New button visibility
            if (sectionId === 'exhibitions' || sectionId === 'categories') {
                addNewBtn.style.display = 'inline-block';
                addNewBtn.onclick = () => {
                    if (sectionId === 'exhibitions') openAddExhibitionModal();
                    else if (sectionId === 'categories') openAddCategoryModal();
                };
            } else {
                addNewBtn.style.display = 'none';
            }
        }

        // Load Gallery Overview Stats
        async function loadGalleryOverviewStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalArtworks').textContent = (data.data && data.data.artworks) ? data.data.artworks : '0';
                    document.getElementById('totalArtists').textContent = (data.data && data.data.artists) ? data.data.artists : '0';
                    // Fetch pending submissions separately if not part of main stats
                    const submissionsResponse = await fetch(`${API_BASE_URL}/api/submissions?pending=true`, { credentials: 'include' });
                    const submissionsData = await submissionsResponse.json();
                    document.getElementById('pendingSubmissions').textContent = (submissionsData.success && submissionsData.data) ? submissionsData.data.length : '0';
                    document.getElementById('activeExhibitions').textContent = (data.data && data.data.exhibitions) ? data.data.exhibitions : '0';
                }
            } catch (error) {
                console.error('Error loading gallery overview stats:', error);
            }
        }

        // Load Submissions
        async function loadSubmissions() {
            const tableBody = document.getElementById('submissionsTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading submissions...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/submissions?pending=true`, { credentials: 'include' });
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    tableBody.innerHTML = '';
                    data.data.forEach(submission => {
                        const row = tableBody.insertRow();
                        const thumbSrc = resolveUrl(submission.thumbnail_url || submission.image_url || '');
                        const imgTag = thumbSrc ? `<img src="${thumbSrc}" alt="${escapeHtml(submission.artwork_title || '')}" class="artwork-thumbnail">` : '🖼️';
                        row.innerHTML = `
                            <td>${imgTag} ${escapeHtml(submission.artwork_title || '')}</td>
                            <td>${escapeHtml(submission.artist_name || '')}</td>
                            <td>${submission.submitted_at ? new Date(submission.submitted_at).toLocaleDateString() : ''}</td>
                            <td><span class="status-badge status-${submission.status}">${submission.status}</span></td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="openReviewSubmissionModal(${submission.id})">Review</button>
                            </td>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No pending submissions.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center message error">Failed to load submissions.</td></tr>';
            }
        }

        // Open Review Submission Modal
        async function openReviewSubmissionModal(submissionId) {
            document.getElementById('reviewSubmissionId').value = submissionId;
            reviewSubmissionMessage.style.display = 'none';
            reviewSubmissionMessage.className = 'message';

            try {
                const response = await fetch(`${API_BASE_URL}/api/submissions/${submissionId}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success && data.data) {
                    const submission = data.data;
                    document.getElementById('reviewArtworkTitle').textContent = submission.artwork_title;
                    document.getElementById('reviewArtistName').textContent = submission.artist_name;
                    document.getElementById('submissionReviewNotes').textContent = submission.submission_notes || 'N/A';
                    document.getElementById('reviewAction').value = '';
                    document.getElementById('reviewerNotes').value = '';
                    reviewSubmissionModal.style.display = 'flex';
                } else {
                    alert('Submission details not found.');
                }
            } catch (error) {
                console.error('Error fetching submission details:', error);
                alert('Failed to load submission details.');
            }
        }

        // Handle Review Submission
        reviewSubmissionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            reviewSubmissionMessage.style.display = 'none';
            reviewSubmissionMessage.className = 'message';

            const submissionId = document.getElementById('reviewSubmissionId').value;
            const action = document.getElementById('reviewAction').value;
            const reviewerNotes = document.getElementById('reviewerNotes').value;
            const csrfToken = csrfTokenReviewSubmissionInput.value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/submissions`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({ submission_id: submissionId, action: action, review_notes: reviewerNotes })
                });
                const result = await response.json();

                showMessage(reviewSubmissionMessage, result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    loadSubmissions(); // Reload submissions list
                    loadGalleryOverviewStats();
                    setTimeout(() => reviewSubmissionModal.style.display = 'none', 2000);
                }
            } catch (error) {
                console.error('Error reviewing submission:', error);
                showMessage(reviewSubmissionMessage, 'Failed to submit review due to a network error.', 'error');
            }
        });

        // Load All Artworks (for staff)
        async function loadAllArtworks() {
            const tableBody = document.getElementById('artworksTableBody');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Loading artworks...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/artworks`, { credentials: 'include' }); // Staff can see all statuses
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    tableBody.innerHTML = '';
                    data.data.forEach(artwork => {
                        const row = tableBody.insertRow();
                        let src = resolveUrl(artwork.thumbnail_url || artwork.image_url);
                        let alt1 = '';
                        let alt2 = '';
                        if (src) {
                            if (src.includes('/public/uploads/')) {
                                alt1 = src.replace('/public/uploads/','/uploads/');
                            } else if (src.includes('/uploads/')) {
                                alt1 = src.replace('/uploads/','/public/uploads/');
                            }
                            if (artwork.image_url) {
                                const original = resolveUrl(artwork.image_url);
                                if (original && original !== src && original !== alt1) alt2 = original;
                            }
                        }
                        const imgCell = src
                            ? `<img src=\"${src}\" data-alt1=\"${alt1}\" data-alt2=\"${alt2}\" onerror=\"if(this.dataset.alt1 && this.src!==this.dataset.alt1){this.src=this.dataset.alt1; this.dataset.alt1='';} else if(this.dataset.alt2 && this.src!==this.dataset.alt2){this.src=this.dataset.alt2; this.dataset.alt2='';} else {this.src=''; this.alt='No image';}\" alt=\"${escapeHtml(artwork.title)}\" class=\"artwork-thumbnail\">`
                            : '🖼️';
                        row.innerHTML = `
                            <td>${imgCell}</td>
                            <td>${escapeHtml(artwork.title)}</td>
                            <td>${escapeHtml(artwork.artist_name)}</td>
                            <td><span class=\"category-text\">${escapeHtml(artwork.category_name || 'N/A')}</span></td>
                            <td><span class=\"status-badge status-${artwork.status}\">${artwork.status}</span></td>
                            <td>${artwork.featured ? '✔️' : '❌'}</td>
                            <td>${artwork.views_count}</td>
                            <td>
                                <button class=\"btn btn-primary btn-sm\" onclick=\"openEditArtworkModal(${artwork.id})\">Edit</button>
                            </td>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No artworks found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading all artworks:', error);
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center message error">Failed to load artworks.</td></tr>';
            }
        }

        // Reuse openEditArtworkModal, editArtworkForm, deleteArtwork from artist-dashboard.js
        // Ensure csrf_token_edit_artwork is populated

        // Edit Artwork (reused from artist dashboard, adapted for staff)
        async function openEditArtworkModal(artworkId) {
            currentEditArtworkId = artworkId;
            await resetAndPopulateCategorySelect(editArtworkCategorySelect);
            editArtworkMessage.style.display = 'none';
            editArtworkMessage.className = 'message';

            try {
                const response = await fetch(`${API_BASE_URL}/api/artworks/${artworkId}`, { credentials: 'include' }); // Changed to fetch by ID from new API structure
                const data = await response.json();

                if (data.success && data.data) {
                    const artwork = data.data;
                    document.getElementById('editArtworkId').value = artwork.id;
                    document.getElementById('editArtworkTitle').value = artwork.title;
                    document.getElementById('editArtworkDescription').value = artwork.description || '';
                    document.getElementById('editArtworkCategory').value = artwork.category_id;
                    document.getElementById('editArtworkMedium').value = artwork.medium || '';
                    document.getElementById('editArtworkDimensions').value = artwork.dimensions || '';
                    document.getElementById('editArtworkYear').value = artwork.year_created || '';
                    document.getElementById('editArtworkPrice').value = artwork.price || '';
                    document.getElementById('editArtworkStatus').value = artwork.status;
                    document.getElementById('editArtworkFeatured').checked = artwork.featured == 1; // Checkbox for featured
                    currentArtworkImage.src = artwork.thumbnail_url || '#'; // Use thumbnail for preview
                    currentArtworkImage.style.display = artwork.thumbnail_url ? 'block' : 'none';

                    editArtworkModal.style.display = 'flex';
                } else {
                    alert('Artwork not found or failed to load.');
                }
            } catch (error) {
                console.error('Error fetching artwork for edit:', error);
                alert('Failed to load artwork details.');
            }
        }

        editArtworkForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            editArtworkMessage.style.display = 'none';
            editArtworkMessage.className = 'message';

            const artworkId = document.getElementById('editArtworkId').value;
            const csrfToken = csrfTokenEditArtworkInput.value;
            const updatedData = {
                title: document.getElementById('editArtworkTitle').value,
                description: document.getElementById('editArtworkDescription').value,
                category_id: document.getElementById('editArtworkCategory').value,
                medium: document.getElementById('editArtworkMedium').value,
                dimensions: document.getElementById('editArtworkDimensions').value,
                year_created: document.getElementById('editArtworkYear').value,
                price: document.getElementById('editArtworkPrice').value,
                status: document.getElementById('editArtworkStatus').value,
                featured: document.getElementById('editArtworkFeatured').checked ? 1 : 0,
            };

            Object.keys(updatedData).forEach(key => {
                if (updatedData[key] === '' || updatedData[key] === null) {
                    delete updatedData[key];
                }
            });

            try {
                const response = await fetch(`${API_BASE_URL}/api/artworks/${artworkId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json', // Changed to application/json for consistency
                        'X-CSRF-TOKEN': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify(updatedData)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(editArtworkMessage, 'Artwork updated successfully!', 'success');
                    loadAllArtworks(); // Reload artworks list
                    loadGalleryOverviewStats();
                    setTimeout(() => editArtworkModal.style.display = 'none', 2000);
                } else {
                    showMessage(editArtworkMessage, result.message, 'error');
                }
            } catch (error) {
                console.error('Error updating artwork:', error);
                showMessage(editArtworkMessage, 'Failed to update artwork due to a network error.', 'error');
            }
        });

        async function deleteArtwork() {
            if (!confirm('Are you sure you want to delete this artwork? This action cannot be undone.')) {
                return;
            }

            const artworkId = document.getElementById('editArtworkId').value;
            const csrfToken = csrfTokenEditArtworkInput.value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/artworks/${artworkId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken // CSRF token for DELETE
                    },
                    credentials: 'include',
                });
                const result = await response.json();
                const messageDiv = document.getElementById('editArtworkMessage');
                if (result.success) {
                    showMessage(messageDiv, 'Artwork deleted successfully.', 'success');
                    loadAllArtworks();
                    loadGalleryOverviewStats();
                    setTimeout(() => editArtworkModal.style.display = 'none', 2000);
                } else {
                    showMessage(messageDiv, result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting artwork:', error);
                showMessage(document.getElementById('editArtworkMessage'), 'Failed to delete artwork due to a network error.', 'error');
            }
        }

        // Load Exhibitions
        async function loadExhibitions() {
            const tableBody = document.getElementById('exhibitionsTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading exhibitions...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/exhibitions`, { credentials: 'include' });
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    tableBody.innerHTML = '';
                    data.data.forEach(exhibition => {
                        const row = tableBody.insertRow();
                        const startDate = new Date(exhibition.start_date).toLocaleDateString();
                        const endDate = new Date(exhibition.end_date).toLocaleDateString();
                        row.innerHTML = `
                            <td>${escapeHtml(exhibition.name)}</td>
                            <td>${startDate} - ${endDate}</td>
                            <td>${exhibition.artwork_count || 0}</td>
                            <td><span class="status-badge status-${exhibition.status}">${exhibition.status}</span></td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editExhibition(${exhibition.id})">Edit</button>
                                <button class="btn btn-success btn-sm" onclick="manageExhibitionArtworks(${exhibition.id})">Manage Artworks</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteExhibition(${exhibition.id})">Delete</button>
                            </td>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No exhibitions found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading exhibitions:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center message error">Failed to load exhibitions.</td></tr>';
            }
        }

        // Add Exhibition Modal
        function openAddExhibitionModal() {
            addExhibitionForm.reset();
            addExhibitionMessage.style.display = 'none';
            // Ensure we are in create mode (not editing)
            if (addExhibitionModal.dataset.editingId) {
                delete addExhibitionModal.dataset.editingId;
            }
            addExhibitionModal.style.display = 'flex';
        }

        addExhibitionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            addExhibitionMessage.style.display = 'none';
            addExhibitionMessage.className = 'message';

            const csrfToken = csrfTokenAddExhibitionInput.value;
            const exhibitionData = {
                name: document.getElementById('exhibitionName').value,
                description: document.getElementById('exhibitionDescription').value,
                start_date: document.getElementById('exhibitionStartDate').value,
                end_date: document.getElementById('exhibitionEndDate').value,
                max_artworks: document.getElementById('exhibitionMaxArtworks').value,
            };

            try {
                const editingId = addExhibitionModal.dataset.editingId;
                const isEdit = !!editingId;
                const url = isEdit ? `${API_BASE_URL}/api/exhibitions/${editingId}` : `${API_BASE_URL}/api/exhibitions`;
                const method = isEdit ? 'PUT' : 'POST';
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify(exhibitionData)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(addExhibitionMessage, (isEdit ? 'Exhibition updated successfully!' : 'Exhibition created successfully!'), 'success');
                    addExhibitionForm.reset();
                    delete addExhibitionModal.dataset.editingId;
                    loadExhibitions();
                    loadGalleryOverviewStats();
                    setTimeout(() => addExhibitionModal.style.display = 'none', 2000);
                } else {
                    showMessage(addExhibitionMessage, result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding exhibition:', error);
                showMessage(addExhibitionMessage, 'Failed to create exhibition due to a network error.', 'error');
            }
        });

        // Edit/Delete Exhibition
        function editExhibition(id) {
            populateExhibitionForm(id);
        }

        async function populateExhibitionForm(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/exhibitions`, { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    const ex = (data.data || []).find(e => String(e.id) === String(id));
                    if (!ex) { alert('Exhibition not found'); return; }
                    document.getElementById('exhibitionName').value = ex.name || '';
                    document.getElementById('exhibitionDescription').value = ex.description || '';
                    document.getElementById('exhibitionStartDate').value = ex.start_date ? ex.start_date.substring(0,10) : '';
                    document.getElementById('exhibitionEndDate').value = ex.end_date ? ex.end_date.substring(0,10) : '';
                    document.getElementById('exhibitionMaxArtworks').value = ex.max_artworks || 50;
                    addExhibitionModal.dataset.editingId = id;
                    addExhibitionModal.style.display = 'flex';
                }
            } catch (e) { alert('Failed to load exhibition'); }
        }

        async function deleteExhibition(id) {
            if (!confirm('Are you sure you want to delete exhibition ID: ' + id + '?')) return;
            try {
                const csrf = csrfTokenAddExhibitionInput.value;
                const res = await fetch(`${API_BASE_URL}/api/exhibitions/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRF-TOKEN': csrf },
                    credentials: 'include'
                });
                const out = await res.json();
                if (out.success) { loadExhibitions(); loadGalleryOverviewStats(); }
                else alert(out.message || 'Failed to delete');
            } catch(e){ alert('Delete failed'); }
        }

        // Load Categories Table
        async function loadCategoriesTable() {
            const tableBody = document.getElementById('categoriesTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading categories...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/categories`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    tableBody.innerHTML = '';
                    data.data.forEach(category => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${escapeHtml(category.name)}</td>
                            <td>${escapeHtml(category.description || 'N/A')}</td>
                            <td>${category.artwork_count}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editCategory(${category.id})">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCategory(${category.id})">Delete</button>
                            </td>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No categories found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center message error">Failed to load categories.</td></tr>';
            }
        }

        // Add Category Modal
        function openAddCategoryModal() {
            addCategoryForm.reset();
            addCategoryMessage.style.display = 'none';
            addCategoryModal.style.display = 'flex';
        }

        addCategoryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            addCategoryMessage.style.display = 'none';
            addCategoryMessage.className = 'message';

            const csrfToken = csrfTokenAddCategoryInput.value;
            const categoryName = document.getElementById('categoryName').value;
            const categoryDescription = document.getElementById('categoryDescription').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({ name: categoryName, description: categoryDescription })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(addCategoryMessage, 'Category added successfully!', 'success');
                    addCategoryForm.reset();
                    await loadCategories(); // Reload global categories list
                    loadCategoriesTable(); // Reload table
                    setTimeout(() => addCategoryModal.style.display = 'none', 2000);
                } else {
                    showMessage(addCategoryMessage, result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showMessage(addCategoryMessage, 'Failed to add category due to a network error.', 'error');
            }
        });

        // Edit/Delete Category (placeholders)
        function editCategory(id) {
            alert('Edit Category functionality for ID: ' + id + ' not yet implemented.');
        }

        function deleteCategory(id) {
            if (confirm('Are you sure you want to delete category ID: ' + id + '?')) {
                alert('Delete Category functionality for ID: ' + id + ' not yet implemented.');
            }
        }

        // Load Users Table
        async function loadUsers() {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading users...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/users`, { credentials: 'include' });
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    tableBody.innerHTML = '';
                    data.data.forEach(user => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${escapeHtml(user.name)}</td>
                            <td>${escapeHtml(user.email)}</td>
                            <td><span class="status-badge status-${user.role}">${user.role}</span></td>
                            <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="openChangeRoleModal(${user.id}, '${escapeHtml(user.name)}', '${user.role}')">Change Role</button>
                                <!-- Add more actions if needed, e.g., reset password, ban user -->
                            </td>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No users found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center message error">Failed to load users.</td></tr>';
            }
        }

        // Change User Role Modal
        function openChangeRoleModal(userId, userName, currentRole) {
            document.getElementById('changeRoleUserId').value = userId;
            document.getElementById('changeRoleUserName').textContent = userName;
            document.getElementById('newUserRole').value = currentRole; // Set current role as default
            changeRoleMessage.style.display = 'none';
            changeRoleModal.style.display = 'flex';
        }

        changeRoleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            changeRoleMessage.style.display = 'none';
            changeRoleMessage.className = 'message';

            const userId = document.getElementById('changeRoleUserId').value;
            const newRole = document.getElementById('newUserRole').value;
            const csrfToken = csrfTokenChangeRoleInput.value;

            if (!newRole) {
                showMessage(changeRoleMessage, 'Please select a new role.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/change-role/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json', // Changed to application/json for consistency
                        'X-CSRF-TOKEN': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({ new_role: newRole })
                });
                const result = await response.json();

                showMessage(changeRoleMessage, result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    loadUsers(); // Reload users table
                    setTimeout(() => changeRoleModal.style.display = 'none', 2000);
                }
            } catch (error) {
                console.error('Error changing user role:', error);
                showMessage(changeRoleMessage, 'Failed to change user role due to a network error.', 'error');
            }
        });

        // Common Functions (reused from artist dashboard or generic)
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/categories`);
                const data = await response.json();
                if (data.success) {
                    categories = data.data;
                } else {
                    console.error('Failed to load categories:', data.message);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function resetAndPopulateCategorySelect(selectElement) {
            selectElement.innerHTML = '<option value="">Select Category</option>'; // Clear existing options
            if (categories.length === 0) {
                await loadCategories(); // Ensure categories are loaded
            }
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function resolveUrl(url) {
            if (!url) return '';
            let u = String(url).replace(/\\\\/g,'/');
            if (u.startsWith('http')) return u;
            if (u.startsWith('/')) return u;
            // strip Windows drive or leading slash
            u = u.replace(/^[A-Za-z]:\//, '').replace(/^\//, '');
            // already contains project base
            const baseIdx = u.indexOf('/usanii_mashariki/');
            if (baseIdx !== -1) return u.substring(baseIdx);
            // map known upload locations
            const pubIdx = u.indexOf('public/uploads/');
            if (pubIdx !== -1) return `/usanii_mashariki/${u.substring(pubIdx)}`;
            if (u.startsWith('uploads/')) return `/usanii_mashariki/public/${u}`;
            return `/usanii_mashariki/${u}`;
        }

        // Exhibition Artworks Management
        let currentExhibitionId = null;

        async function manageExhibitionArtworks(exhibitionId) {
            currentExhibitionId = exhibitionId;
            await loadExhibitionArtworks(exhibitionId);
            await loadAvailableArtworks(exhibitionId);
            exhibitionArtworksModal.style.display = 'flex';
        }

        async function loadExhibitionArtworks(exhibitionId) {
            const container = document.getElementById('exhibitionArtworksContainer');
            container.innerHTML = '<p>Loading artworks...</p>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/exhibition-artworks/${exhibitionId}/artworks`, { 
                    credentials: 'include' 
                });
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = '';
                    data.data.forEach(artwork => {
                        const artworkDiv = document.createElement('div');
                        artworkDiv.className = 'artwork-item';
                        const primary = resolveUrl(artwork.thumbnail_url || artwork.image_url);
                        const fallback = resolveUrl(artwork.image_url || '');
                        artworkDiv.innerHTML = `
                            <div class="artwork-info">
                                <img src="${primary}" data-alt="${fallback}" onerror="if(this.dataset.alt && this.src!==this.dataset.alt){this.src=this.dataset.alt; this.dataset.alt='';} else {this.style.display='none';}" alt="${escapeHtml(artwork.title)}" class="artwork-thumbnail">
                                <div>
                                    <h4>${escapeHtml(artwork.title)}</h4>
                                    <p>Artist: ${escapeHtml(artwork.artist_name)}</p>
                                    <p>Category: ${escapeHtml(artwork.category_name)}</p>
                                </div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="removeArtworkFromExhibition(${exhibitionId}, ${artwork.id})">Remove</button>
                        `;
                        container.appendChild(artworkDiv);
                    });
                } else {
                    container.innerHTML = '<p>No artworks in this exhibition.</p>';
                }
            } catch (error) {
                console.error('Error loading exhibition artworks:', error);
                container.innerHTML = '<p class="error">Failed to load artworks.</p>';
            }
        }

        async function loadAvailableArtworks(exhibitionId) {
            const select = document.getElementById('availableArtworksSelect');
            select.innerHTML = '<option value="">Select an artwork to add...</option>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/exhibition-artworks/${exhibitionId}/available`, { 
                    credentials: 'include' 
                });
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(artwork => {
                        const option = document.createElement('option');
                        option.value = artwork.id;
                        option.textContent = `${artwork.title} by ${artwork.artist_name}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No available artworks</option>';
                }
            } catch (error) {
                console.error('Error loading available artworks:', error);
                select.innerHTML = '<option value="">Error loading artworks</option>';
            }
        }

        async function addArtworkToExhibition() {
            const artworkId = document.getElementById('availableArtworksSelect').value;
            if (!artworkId) {
                alert('Please select an artwork to add.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/exhibition-artworks/${currentExhibitionId}/artworks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.getElementById('csrf_token_exhibition_artworks').value
                    },
                    credentials: 'include',
                    body: JSON.stringify({ artwork_id: artworkId })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Artwork added to exhibition successfully!');
                    await loadExhibitionArtworks(currentExhibitionId);
                    await loadAvailableArtworks(currentExhibitionId);
                    loadExhibitions(); // Refresh exhibitions table
                } else {
                    alert('Failed to add artwork: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding artwork to exhibition:', error);
                alert('Failed to add artwork due to a network error.');
            }
        }

        async function removeArtworkFromExhibition(exhibitionId, artworkId) {
            if (!confirm('Are you sure you want to remove this artwork from the exhibition?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/exhibition-artworks/${exhibitionId}/artworks/${artworkId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-TOKEN': document.getElementById('csrf_token_exhibition_artworks').value
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Artwork removed from exhibition successfully!');
                    await loadExhibitionArtworks(exhibitionId);
                    await loadAvailableArtworks(exhibitionId);
                    loadExhibitions(); // Refresh exhibitions table
                } else {
                    alert('Failed to remove artwork: ' + data.message);
                }
            } catch (error) {
                console.error('Error removing artwork from exhibition:', error);
                alert('Failed to remove artwork due to a network error.');
            }
        }

        // Download Reports Function
        async function downloadReport(reportType, format) {
            try {
                const url = `${API_BASE_URL}/api/reports?type=${reportType}&format=${format}`;
                
                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                link.href = url;
                link.download = `${reportType}_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.${format}`;
                
                // Add credentials to the request
                link.setAttribute('data-credentials', 'include');
                
                // Trigger the download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                alert(`Downloading ${reportType} report in ${format.toUpperCase()} format...`);
                
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Failed to download report. Please try again.');
            }
        }

        // Close Modals
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', function() {
                document.getElementById(this.dataset.modal).style.display = 'none';
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target == reviewSubmissionModal) {
                reviewSubmissionModal.style.display = 'none';
            }
            if (event.target == editArtworkModal) {
                editArtworkModal.style.display = 'none';
            }
            if (event.target == addExhibitionModal) {
                addExhibitionModal.style.display = 'none';
            }
            if (event.target == addCategoryModal) {
                addCategoryModal.style.display = 'none';
            }
            if (event.target == changeRoleModal) {
                changeRoleModal.style.display = 'none';
            }
            if (event.target == exhibitionArtworksModal) {
                exhibitionArtworksModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
