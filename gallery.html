<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Usanii Mashariki</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style>
        :root { --primary:#2c5530; --secondary:#8B4513; --accent:#D4AF37; --light:#f8f9fa; --dark:#2c3e50; --white:#fff; --radius:12px; }
        body { margin:0; font-family: Georgia, serif; color:var(--dark); background:var(--light); }
        header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:1rem 0; box-shadow:0 4px 6px rgba(0,0,0,.1); position:sticky; top:0; z-index:5; }
        .container { max-width:1200px; margin:0 auto; padding:0 1rem; }
        .bar { display:flex; gap:1rem; align-items:center; justify-content:space-between; }
        .logo { font-weight:bold; font-size:1.2rem; }
        .btn { background:var(--accent); color:var(--dark); border:none; padding:.6rem 1rem; border-radius:10px; cursor:pointer; text-decoration:none; }
        .panel { background:#fff; border-radius:var(--radius); box-shadow:0 4px 10px rgba(0,0,0,.08); padding:1rem; margin:1rem 0; }
        .filters { display:grid; gap:.75rem; grid-template-columns: 1fr 180px 140px; }
        .input, select { padding:.7rem; border:1px solid #ddd; border-radius:10px; font-size:1rem; }
        .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
        .card { background:#fff; border-radius:var(--radius); overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.06); display:flex; flex-direction:column; }
        .thumb { width:100%; height:180px; object-fit:cover; background:#eee; }
        .card-body { padding:1rem; }
        .title { font-size:1.1rem; margin:.2rem 0; color:var(--dark); }
        .artist { color:var(--primary); font-weight:500; margin-bottom:.4rem; }
        .meta { color:#7f8c8d; font-size:.9rem; }
        .pager { display:flex; gap:.5rem; justify-content:center; margin:1rem 0; }
        .pager .btn { background:#e9ecef; color:#333; }
        @media (max-width:700px){ .filters{ grid-template-columns:1fr; } }
    </style>
    <script>
        const API_BASE_URL = window.location.origin + '/usanii_mashariki';
        let state = { page: 1, limit: 12, total: 0, category: '', search: '' };
        document.addEventListener('DOMContentLoaded', () => {
            bindUI();
            loadCategories();
            loadArtworks();
        });
        function bindUI(){
            document.getElementById('search').addEventListener('input', debounce(e=>{ state.search=e.target.value.trim(); state.page=1; loadArtworks(); }, 400));
            document.getElementById('category').addEventListener('change', e=>{ state.category=e.target.value; state.page=1; loadArtworks(); });
            const prevTop = document.getElementById('prev');
            const nextTop = document.getElementById('next');
            if (prevTop) prevTop.addEventListener('click', ()=>{ if(state.page>1){ state.page--; loadArtworks(); }});
            if (nextTop) nextTop.addEventListener('click', ()=>{ state.page++; loadArtworks(); });
            // Bottom pager
            const prevB = document.getElementById('prevBottom');
            const nextB = document.getElementById('nextBottom');
            if (prevB && nextB) {
                prevB.addEventListener('click', ()=>{ if(state.page>1){ state.page--; loadArtworks(); }});
                nextB.addEventListener('click', ()=>{ state.page++; loadArtworks(); });
            }
        }
        async function loadCategories(){
            try{
                const res = await fetch(`${API_BASE_URL}/api/categories`);
                const data = await res.json();
                const sel = document.getElementById('category');
                sel.innerHTML = '<option value="">All categories</option>';
                (data.success?data.data:[]).forEach(c=>{
                    const opt = document.createElement('option');
                    opt.value = c.id; opt.textContent = c.name; sel.appendChild(opt);
                });
            }catch(e){}
        }
        async function loadArtworks(){
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div class="panel">Loading artworks...</div>';
            try{
                const params = new URLSearchParams();
                params.set('status','approved');
                params.set('limit', state.limit);
                params.set('offset', (state.page-1)*state.limit);
                if(state.category) params.set('category_id', state.category);
                if(state.search) params.set('search', state.search);
                const res = await fetch(`${API_BASE_URL}/api/artworks?${params.toString()}`);
                const data = await res.json();
                const items = (data.success?data.data:[]);
                grid.innerHTML = '';
                if(items.length===0){ grid.innerHTML = '<div class="panel">No artworks found.</div>'; }
                items.forEach(a=> grid.appendChild(renderCard(a)) );
                // Note: API doesn't provide total. We keep simple next/prev by checking count < limit.
                const prevTop = document.getElementById('prev');
                const nextTop = document.getElementById('next');
                const pageTop = document.getElementById('page');
                const prevBottom = document.getElementById('prevBottom');
                const nextBottom = document.getElementById('nextBottom');
                const pageBottom = document.getElementById('pageBottom');
                const disablePrev = state.page===1;
                const disableNext = items.length < state.limit;
                if (prevTop) prevTop.disabled = disablePrev;
                if (nextTop) nextTop.disabled = disableNext;
                if (pageTop) pageTop.textContent = `Page ${state.page}`;
                if (prevBottom) prevBottom.disabled = disablePrev;
                if (nextBottom) nextBottom.disabled = disableNext;
                if (pageBottom) pageBottom.textContent = `Page ${state.page}`;
            }catch(e){ grid.innerHTML = '<div class="panel">Failed to load artworks.</div>'; }
        }
        function renderCard(a){
            const div = document.createElement('div');
            div.className = 'card';
            // Resilient image fallback: try public/uploads, then uploads, then original image
            let src = resolveUrl(a.thumbnail_url || a.image_url || '');
            let alt1 = '';
            let alt2 = '';
            if (src) {
                if (src.includes('/public/uploads/')) {
                    alt1 = src.replace('/public/uploads/','/uploads/');
                } else if (src.includes('/uploads/')) {
                    alt1 = src.replace('/uploads/','/public/uploads/');
                }
                if (a.image_url) {
                    const original = resolveUrl(a.image_url);
                    if (original && original !== src && original !== alt1) alt2 = original;
                }
            }
            const imgMarkup = src
                ? `<img class="thumb" src="${src}" data-alt1="${alt1}" data-alt2="${alt2}" onerror="if(this.dataset.alt1 && this.src!==this.dataset.alt1){this.src=this.dataset.alt1; this.dataset.alt1='';} else if(this.dataset.alt2 && this.src!==this.dataset.alt2){this.src=this.dataset.alt2; this.dataset.alt2='';} else {this.src=''; this.alt='No image';}" alt="${escapeHtml(a.title||'')}">`
                : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;">üñºÔ∏è</div>`;

            div.innerHTML = `
                ${imgMarkup}
                <div class="card-body">
                    <div class="artist">${escapeHtml(a.artist_name||'')}</div>
                    <div class="title">${escapeHtml(a.title||'Untitled')}</div>
                    <div class="meta">${escapeHtml(a.category_name||'')}${a.price?` ‚Ä¢ ${formatCurrency(a.price)}`:''}</div>
                </div>`;
            div.onclick = ()=>{ if (a.id) window.location.href = `artwork.html?id=${a.id}`; };
            return div;
        }
        function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms); } }
        function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
        function resolveUrl(url){
            if(!url) return '';
            let u = String(url).replace(/\\\\/g,'/'); // normalize backslashes
            if (u.startsWith('http')) return u;
            if (u.startsWith('/')) return u;
            // strip Windows drive prefix or leading slash
            u = u.replace(/^[A-Za-z]:\//, '').replace(/^\//, '');
            // if path already contains project base
            const baseIdx = u.indexOf('/usanii_mashariki/');
            if (baseIdx !== -1) return u.substring(baseIdx);
            // map to public/uploads if present
            const pubIdx = u.indexOf('public/uploads/');
            if (pubIdx !== -1) return `/usanii_mashariki/${u.substring(pubIdx)}`;
            if (u.startsWith('uploads/')) return `/usanii_mashariki/public/${u}`;
            return `/usanii_mashariki/${u}`;
        }
        function formatCurrency(v){ const n=Number(v); if(Number.isNaN(n)) return ''; return new Intl.NumberFormat(undefined,{style:'currency',currency:'KES',maximumFractionDigits:0}).format(n); }
    </script>
</head>
<body>
    <header>
        <div class="container bar">
            <div class="logo">üé® Usanii Mashariki ‚Äî Gallery</div>
            <nav>
                <a class="btn" href="index.html">Home</a>
            </nav>
        </div>
    </header>
    <main class="container">
        <div class="panel">
            <div class="filters">
                <input id="search" class="input" type="text" placeholder="Search artworks or artists..." />
                <select id="category"></select>
            </div>
        </div>
        <div id="grid" class="grid"></div>
        <div class="panel" style="margin-top:1rem;">
            <div class="pager">
                <button id="prevBottom" class="btn" type="button">Prev</button>
                <span id="pageBottom" style="align-self:center; padding:0 .5rem;">Page 1</span>
                <button id="nextBottom" class="btn" type="button">Next</button>
            </div>
        </div>
    </main>
</body>
</html>


