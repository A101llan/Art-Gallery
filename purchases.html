<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Purchases - Usanii Mashariki</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style>
        :root { --primary:#2c5530; --secondary:#8B4513; --accent:#D4AF37; --light:#f8f9fa; --dark:#2c3e50; --white:#fff; --radius:12px; }
        body { margin:0; font-family: Georgia, serif; color:var(--dark); background:var(--light); }
        header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:1rem 0; box-shadow:0 4px 6px rgba(0,0,0,.1); position:sticky; top:0; z-index:5; }
        .container { max-width:1100px; margin:0 auto; padding:0 1rem; }
        .bar { display:flex; gap:1rem; align-items:center; justify-content:space-between; }
        .logo { font-weight:bold; font-size:1.2rem; }
        .btn { background:var(--accent); color:var(--dark); border:none; padding:.6rem 1rem; border-radius:10px; cursor:pointer; text-decoration:none; }
        .panel { background:#fff; border-radius:var(--radius); box-shadow:0 4px 10px rgba(0,0,0,.08); padding:1rem; margin:1rem 0; }
        .grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
        .card { background:#fff; border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,.1); overflow:hidden; cursor:pointer; transition:transform 0.2s; }
        .card:hover { transform:translateY(-2px); }
        .thumb { width:100%; height:200px; object-fit:cover; background:#eee; }
        .card-body { padding:1rem; }
        .title { font-size:1.1rem; font-weight:600; margin-bottom:.5rem; color:var(--dark); }
        .artist { color:var(--primary); font-weight:500; margin-bottom:.25rem; }
        .meta { color:#7f8c8d; font-size:.9rem; margin-bottom:.5rem; }
        .price { font-size:1.1rem; font-weight:700; color:var(--primary); }
        .purchase-date { color:#7f8c8d; font-size:.8rem; margin-top:.5rem; }
        .empty-state { text-align:center; padding:3rem 1rem; color:#7f8c8d; }
        .empty-state h3 { margin-bottom:.5rem; }
        .loading { text-align:center; padding:2rem; color:#7f8c8d; }
    </style>
    <script>
        const API_BASE_URL = window.location.origin + '/usanii_mashariki';
        
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            loadPurchases();
        });
        
        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/status`, { credentials: 'include' });
                const redirectUrl = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                if (!res.ok) { window.location.replace(redirectUrl); return false; }
                const data = await res.json();
                if (!data || !data.success || !data.user) { window.location.replace(redirectUrl); return false; }
                return true;
            } catch(e) {
                const redirectUrl = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                window.location.replace(redirectUrl);
                return false;
            }
        }
        
        async function loadPurchases() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div class="loading">Loading your purchases...</div>';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/purchases`, { credentials: 'include' });
                if (res.status === 401) {
                    const redirectUrl = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                    window.location.replace(redirectUrl);
                    return;
                }
                const data = await res.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    grid.innerHTML = '';
                    data.data.forEach(p => {
                        grid.appendChild(renderPurchaseCard(p));
                    });
                } else {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>No purchases yet</h3>
                            <p>Start exploring our gallery and enquire on artworks you love!</p>
                            <a href="gallery.html" class="btn" style="margin-top:1rem;">Browse Gallery</a>
                        </div>
                    `;
                }
            } catch(e) {
                grid.innerHTML = '<div class="panel">Failed to load purchases.</div>';
            }
        }
        
        function renderPurchaseCard(p) {
            const div = document.createElement('div');
            div.className = 'card';
            const src = resolveUrl(p.image_url || '');
            const imgMarkup = src 
                ? `<img class="thumb" src="${src}" alt="${escapeHtml(p.title || '')}">`
                : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;">üñºÔ∏è</div>`;
            const created = p.created_at ? new Date(p.created_at).toLocaleString() : '';
            
            div.innerHTML = `
                ${imgMarkup}
                <div class="card-body">
                    <div class="title">${escapeHtml(p.title || 'Untitled')}</div>
                    <div class="meta">Amount: ${formatCurrency(p.amount || 0)}</div>
                    <div class="meta">Status: ${escapeHtml(p.status || '')}${p.mpesa_receipt_number ? ' ¬∑ Receipt: ' + escapeHtml(p.mpesa_receipt_number) : ''}</div>
                    <div class="purchase-date">${created}</div>
                </div>
            `;
            
            div.onclick = () => {
                if (p.artwork_id) {
                    window.location.href = `artwork.html?id=${p.artwork_id}`;
                }
            };
            
            return div;
        }
        
        function escapeHtml(t) { 
            const d = document.createElement('div'); 
            d.textContent = t || ''; 
            return d.innerHTML; 
        }
        
        function resolveUrl(url) {
            if (!url) return '';
            let u = String(url).replace(/\\\\/g, '/');
            if (u.startsWith('http')) return u;
            if (u.startsWith('/')) return u;
            u = u.replace(/^[A-Za-z]:\//, '').replace(/^\//, '');
            const baseIdx = u.indexOf('/usanii_mashariki/');
            if (baseIdx !== -1) return u.substring(baseIdx);
            const pubIdx = u.indexOf('public/uploads/');
            if (pubIdx !== -1) return `/usanii_mashariki/${u.substring(pubIdx)}`;
            if (u.startsWith('uploads/')) return `/usanii_mashariki/public/${u}`;
            return `/usanii_mashariki/${u}`;
        }
        
        function formatCurrency(v) { 
            const n = Number(v); 
            if (Number.isNaN(n)) return ''; 
            return new Intl.NumberFormat(undefined, {
                style: 'currency', 
                currency: 'KES', 
                maximumFractionDigits: 0
            }).format(n); 
        }
    </script>
</head>
<body>
    <header>
        <div class="container bar">
            <div class="logo">üé® Usanii Mashariki ‚Äî My Purchases</div>
            <nav>
                <a class="btn" href="gallery.html">Gallery</a>
                <a class="btn" href="index.html">Home</a>
            </nav>
        </div>
    </header>
    <main class="container">
        <div class="panel">
            <h2>My Purchases</h2>
            <p>View your payments and purchased artworks.</p>
        </div>
        <div id="grid" class="grid"></div>
    </main>
</body>
</html>





